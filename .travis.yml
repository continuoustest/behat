language: php
os: linux
php:
  - 7.3

stages:
  - prepare
  - testing
  - name: deploy
    if: branch = feat/travis

cache:
  timeout: 3600
  directories:
    - $HOME/.cache/$TRAVIS_BUILD_ID/test
    - $HOME/.cache/$TRAVIS_BUILD_ID/dist

jobs:
  include:
    - stage: prepare
      name: Packages Test
      script:
        - composer install --no-interaction --prefer-dist --no-progress --no-suggest
        - mkdir -p $HOME/.cache/$TRAVIS_BUILD_ID/test
        - cp -r . $HOME/.cache/$TRAVIS_BUILD_ID/test/

    - name: Package Dist
      script:
        - composer install --no-interaction --prefer-dist --no-progress --no-suggest --no-dev
        - echo "dist package" > hello
        - mkdir -p $HOME/.cache/$TRAVIS_BUILD_ID/dist
        - cp -r . $HOME/.cache/$TRAVIS_BUILD_ID/dist/

    - stage: testing
      name: Linter
      git:
        clone: false
      script:
        - cp -r $HOME/.cache/$TRAVIS_BUILD_ID/test/* .
        - php -l src/dynamic.php

    - name: Behat
      git:
      clone: false
      script:
        - cp -r $HOME/.cache/$TRAVIS_BUILD_ID/test/* .
        #- ./vendor/bin/behat -c ./behat.yml --colors -f pretty -vv

    - stage: deploy
      name: Deploy
      git:
        clone: false
      script:
        - cp -r $HOME/.cache/$TRAVIS_BUILD_ID/dist/* .
        - ls -lh
        - cat hello
